<!DOCTYPE html>
<html lang="pt-BR" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cozinha - Lanchô</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .order-card {
            transition: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        .order-card.completed {
            transform: scale(0.95);
            opacity: 0;
        }
        .new-order-flash {
            animation: flash-border 1.5s 2;
        }
        @keyframes flash-border {
            0%, 100% { box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.7); } /* Amarelo */
            50% { box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.7); }  /* Vermelho */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex flex-col min-h-screen">

    <header class="bg-white shadow-sm sticky top-0 z-20">
        <nav class="container mx-auto px-4 md:px-8 py-2 flex justify-between items-center">
            <div class="relative">
                <button id="main-menu-button" class="p-2 rounded-full text-gray-600 hover:bg-gray-200">
                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                </button>
                <div id="main-menu-dropdown" class="hidden absolute left-0 mt-2 w-56 bg-white rounded-lg shadow-xl overflow-hidden z-30">
                    <a href="./index.html" class="block py-2 px-4 text-sm text-gray-700 hover:bg-yellow-100"><i class="fas fa-home w-6 mr-2"></i>Home</a>
                    <a href="./catalog.html" class="block py-2 px-4 text-sm text-gray-700 hover:bg-yellow-100"><i class="fas fa-book-open w-6 mr-2"></i>Cardápio</a>
                    <a href="./ofertas.html" class="block py-2 px-4 text-sm text-gray-700 hover:bg-yellow-100"><i class="fas fa-tags w-6 mr-2"></i>Ofertas</a>
                    <a href="./sobre.html" class="block py-2 px-4 text-sm text-gray-700 hover:bg-yellow-100"><i class="fas fa-users w-6 mr-2"></i>Sobre Nós</a>
                </div>
            </div>
            <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2">
                <a href="./index.html"><img src="./images/LANCHO_LOGO.png" alt="Logo Lanchô" class="h-16 w-auto"></a>
            </div>
            <div class="flex items-center space-x-4">
                <div id="user-menu-container" class="relative"></div>
            </div>
        </nav>
    </header>

    <main class="container mx-auto p-6 flex-grow">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Painel da Cozinha</h1>
            <div id="active-orders-count" class="text-lg font-semibold text-gray-600"></div>
        </div>
        <div id="orders-list" class="space-y-6">
            <!-- As comandas dos pedidos serão inseridas aqui -->
        </div>
    </main>

    <footer class="bg-gray-800 text-white mt-auto">
        <div class="container mx-auto px-4 md:px-8 py-12">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8 text-center md:text-left">
                <div>
                    <h3 class="text-lg font-bold text-yellow-500 mb-4">Lanchô</h3>
                    <p class="text-gray-400">O melhor lanche da região, feito com carinho e os ingredientes mais frescos.</p>
                </div>
                <div>
                    <h3 class="text-lg font-bold mb-4">Links Rápidos</h3>
                    <ul class="space-y-2">
                        <li><a href="./index.html" class="text-gray-400 hover:text-white">Home</a></li>
                        <li><a href="./catalog.html" class="text-gray-400 hover:text-white">Cardápio</a></li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-lg font-bold mb-4">Contato</h3>
                    <ul class="space-y-2 text-gray-400">
                        <li>Rua Mariz e Barros, 273, Rio de Janeiro</li>
                        <li>(21) 96810-5812</li>
                        <li>contato@lancho.com.br</li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-lg font-bold mb-4">Siga-nos</h3>
                    <div class="flex justify-center md:justify-start space-x-4">
                        <a href="#" class="text-gray-400 hover:text-white"><i class="fab fa-instagram fa-lg"></i></a>
                        <a href="#" class="text-gray-400 hover:text-white"><i class="fab fa-twitter fa-lg"></i></a>
                    </div>
                </div>
            </div>
            <div class="border-t border-gray-700 mt-8 pt-6 text-center text-gray-500">
                <p>&copy; 2025 Lanchô. Todos os direitos reservados.</p>
            </div>
        </div>
    </footer>

    <audio id="notification-sound" src="https://freesound.org/data/previews/415/415762_6142149-lq.mp3" preload="auto"></audio>

    <script>
        const SUPABASE_URL = 'https://ygsziltorjcgpjbmlptr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlnc3ppbHRvcmpjZ3BqYm1scHRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgyOTUzNTQsImV4cCI6MjA2Mzg3MTM1NH0.3J19gnI_qwM3nWolVdvCcNNusC3YlOTvZEjOwM6z2PU';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const ordersList = document.getElementById('orders-list');
        const activeOrdersCount = document.getElementById('active-orders-count');
        const notificationSound = document.getElementById('notification-sound');
        const userMenuContainer = document.getElementById('user-menu-container');

        const statusConfig = {
            'pendente': {
                borderColor: 'border-yellow-400',
                buttonClass: 'bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 shadow-lg hover:shadow-blue-500/50',
                buttonIcon: 'fa-play',
                buttonText: 'Iniciar Preparo',
                nextStatus: 'em preparo'
            },
            'em preparo': {
                borderColor: 'border-blue-400',
                buttonClass: 'bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 shadow-lg hover:shadow-green-500/50',
                buttonIcon: 'fa-check',
                buttonText: 'Pronto p/ Entrega',
                nextStatus: 'saiu para entrega'
            },
            'saiu para entrega': {
                borderColor: 'border-green-400',
                buttonClass: 'bg-gray-400 cursor-not-allowed',
                buttonIcon: 'fa-check-double',
                buttonText: 'Aguardando Entrega',
                nextStatus: null
            }
        };

        function timeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);
            let interval = Math.floor(seconds / 60);
            if (interval < 1) return "agora";
            if (interval < 60) return `${interval} min atrás`;
            interval = Math.floor(seconds / 3600);
            if (interval < 24) return `${interval}h atrás`;
            interval = Math.floor(seconds / 86400);
            return `${interval}d atrás`;
        }
        
        function parseDescription(description) {
            const items = description.split(/(?=\d+x)/);
            return items.map(item => item.trim()).filter(Boolean);
        }

        function renderOrderCard(order) {
            const config = statusConfig[order.status.toLowerCase()] || {};
            
            const parsedItems = parseDescription(order.descricao);
            const itemsHtml = parsedItems.map(itemString => {
                const match = itemString.match(/(\d+x\s)?([^()]+)(\(.*\))?/);
                if (!match) return `<p>${itemString}</p>`;

                const quantity = match[1] || '1x ';
                const productName = match[2].trim();
                const customizations = match[3] ? match[3].replace(/[()]/g, '').split(',').map(c => {
                    const trimmed = c.trim();
                    if (trimmed.startsWith('+')) return `<li class="text-green-600">${trimmed}</li>`;
                    if (trimmed.startsWith('sem')) return `<li class="text-red-600">${trimmed}</li>`;
                    return `<li>${trimmed}</li>`;
                }).join('') : '<li class="text-gray-400 italic">Item padrão</li>';

                return `
                <div class="mt-2">
                    <p class="font-semibold text-gray-800">${quantity}${productName}</p>
                    <ul class="text-xs ml-5 list-disc">${customizations}</ul>
                </div>`;
            }).join('');

            return `
            <div id="order-card-${order.id}" class="bg-white rounded-lg shadow-md p-5 order-card border-l-8 ${config.borderColor}">
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <h3 class="font-black text-xl text-gray-800">Pedido #${String(order.id).padStart(4, '0')}</h3>
                        <p class="text-sm text-gray-500">${order.Cliente ? order.Cliente.nome : 'Não identificado'}</p>
                    </div>
                    <span class="text-sm font-semibold text-red-600" data-time="${order.data}">${timeAgo(order.data)}</span>
                </div>
                <div class="space-y-2 my-4 border-t border-b py-4">${itemsHtml}</div>
                <div class="mt-4">
                    <button ${config.nextStatus ? `onclick="updateOrderStatus(${order.id}, '${config.nextStatus}')"` : 'disabled'} 
                            class="w-full text-white font-bold py-3 px-4 rounded-lg transition-all duration-300 transform hover:scale-105 shadow-md ${config.buttonClass}">
                        <i class="fas ${config.buttonIcon} mr-2"></i> ${config.buttonText}
                    </button>
                </div>
            </div>`;
        }

        function updateAllTimers() {
            document.querySelectorAll('[data-time]').forEach(el => {
                el.textContent = `${timeAgo(el.dataset.time)}`;
            });
        }
        setInterval(updateAllTimers, 30000);

        async function fetchAndRenderOrders() {
            const { data: orders, error } = await supabaseClient
                .from('Pedido')
                .select(`*, Cliente (nome)`)
                .in('status', ['pendente', 'em preparo', 'saiu para entrega'])
                .order('data', { ascending: true });

            if (error) { console.error("Erro ao buscar pedidos:", error); return; }

            activeOrdersCount.textContent = `${orders.length} Pedido(s) Ativo(s)`;
            
            if (orders.length === 0) {
                ordersList.innerHTML = '<p class="text-center text-gray-500 text-lg mt-10">Nenhum pedido na cozinha. Hora de um cafezinho!</p>';
                return;
            }

            ordersList.innerHTML = orders.map(renderOrderCard).join('');
            updateAllTimers();
        }

        function setupRealtimeListener() {
            supabaseClient.channel('public:Pedido')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'Pedido' }, payload => {
                    const isNewOrder = payload.eventType === 'INSERT' && payload.new.status.toLowerCase() === 'pendente';
                    if (isNewOrder) {
                        notificationSound.play().catch(e => console.error("Erro ao tocar som:", e));
                    }
                    
                    fetchAndRenderOrders().then(() => {
                        if (isNewOrder) {
                             const newCard = document.getElementById(`order-card-${payload.new.id}`);
                             if (newCard) newCard.classList.add('new-order-flash');
                        }
                    });
                }).subscribe();
        }

        async function updateOrderStatus(orderId, newStatus) {
            const { error } = await supabaseClient
                .from('Pedido')
                .update({ status: newStatus })
                .eq('id', orderId);

            if (error) {
                console.error("Erro ao atualizar status:", error);
                alert("Não foi possível atualizar o status do pedido.");
            }
        }
        
        async function setupAuthAndInitialize() {
            const userString = localStorage.getItem('currentUser') || localStorage.getItem('currentAdmin');
            if (userString) {
                const loggedUser = JSON.parse(userString);
                if (loggedUser.role !== 'cozinha' && loggedUser.role !== 'admin') {
                    alert('Acesso negado. Você não tem permissão para ver esta página.');
                    window.location.href = './login.html';
                    return;
                }
                await updateNavUI(loggedUser);
                await fetchAndRenderOrders();
                setupRealtimeListener();
            } else {
                alert('Acesso negado. Você precisa estar logado para ver esta página.');
                window.location.href = './login.html';
            }
        }
        
        async function updateNavUI(user) {
            const avatar = user.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.nome || user.email)}&background=fde68a&color=c2410c`;
            userMenuContainer.innerHTML = `
                <button id="user-menu-button" class="p-2 rounded-full focus:outline-none"><img src="${avatar}" alt="Avatar" class="w-8 h-8 rounded-full object-cover"></button>
                <div id="user-menu-dropdown" class="hidden absolute right-0 mt-2 w-72 bg-white rounded-lg shadow-xl overflow-hidden z-30">
                    <div class="p-4 border-b"><div class="flex items-center"><img src="${avatar}" alt="Avatar" class="w-16 h-16 rounded-full object-cover"><div class="ml-4"><p class="font-semibold">${user.nome}</p><p class="text-xs text-gray-500">${user.email}</p></div></div></div>
                    <div class="p-2 border-t"><button id="logout-button" class="w-full text-left flex items-center text-sm text-red-600 hover:bg-red-50 p-2 rounded"><i class="fas fa-sign-out-alt w-6 mr-2"></i>Sair</button></div>
                </div>`;
            
            userMenuContainer.querySelector('#user-menu-button').addEventListener('click', (e) => { 
                e.stopPropagation();
                userMenuContainer.querySelector('#user-menu-dropdown').classList.toggle('hidden');
            });
            userMenuContainer.querySelector('#logout-button').onclick = () => { 
                localStorage.removeItem('currentUser'); 
                localStorage.removeItem('currentAdmin'); 
                window.location.href = './login.html'; 
            };
        }

        const mainMenuButton = document.getElementById('main-menu-button');
        const mainMenuDropdown = document.getElementById('main-menu-dropdown');
        mainMenuButton.addEventListener('click', (event) => {
            event.stopPropagation();
            mainMenuDropdown.classList.toggle('hidden');
        });
        window.addEventListener('click', (event) => {
            if (!mainMenuDropdown.classList.contains('hidden') && !mainMenuButton.contains(event.target) && !mainMenuDropdown.contains(event.target)) {
                mainMenuDropdown.classList.add('hidden');
            }
            const userMenuDropdown = document.getElementById('user-menu-dropdown');
            if (userMenuDropdown && !userMenuDropdown.classList.contains('hidden') && !userMenuDropdown.contains(event.target) && !document.getElementById('user-menu-button')?.contains(event.target)) {
                userMenuDropdown.classList.add('hidden');
            }
        });

        document.addEventListener('DOMContentLoaded', setupAuthAndInitialize);
    </script>
</body>
</html>
