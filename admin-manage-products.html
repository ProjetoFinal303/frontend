<!DOCTYPE html>
<html lang="pt-BR" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Produtos - Admin Lanchô</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }

        /* Estilos para Modals e Notificações */
        .modal, .toast { transition: opacity 0.3s ease, transform 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        .product-card { transition: all 0.3s ease; }
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1); }

        /* Estilos para o Contador de Quantidade "Exuberante" */
        .quantity-stepper { display: flex; align-items: center; gap: 0.5rem; }
        .quantity-btn { width: 2rem; height: 2rem; border-radius: 9999px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; cursor: pointer; transition: background-color 0.2s, transform 0.1s; }
        .quantity-btn:active { transform: scale(0.95); }
        .quantity-minus { background-color: #ef4444; } .quantity-minus:hover { background-color: #dc2626; }
        .quantity-plus { background-color: #22c55e; } .quantity-plus:hover { background-color: #16a34a; }
        .quantity-input { width: 4rem; text-align: center; font-weight: 600; border: 1px solid #d1d5db; border-radius: 0.375rem; padding: 0.25rem; }
        .quantity-input::-webkit-outer-spin-button, .quantity-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .quantity-input[type=number] { -moz-appearance: textfield; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 flex flex-col min-h-screen">

    <header class="bg-white shadow-sm sticky top-0 z-20">
        <nav class="container mx-auto px-4 md:px-8 py-2 flex justify-between items-center">
            <div class="relative">
                <button id="main-menu-button" class="p-2 rounded-full text-gray-600 hover:bg-gray-200">
                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                </button>
                <div id="main-menu-dropdown" class="hidden absolute left-0 mt-2 w-56 bg-white rounded-lg shadow-xl overflow-hidden z-30">
                    <a href="./index.html" class="block py-2 px-4 text-sm text-gray-700 hover:bg-yellow-100"><i class="fas fa-home w-6 mr-2"></i>Home</a>
                    <a href="./catalog.html" class="block py-2 px-4 text-sm text-gray-700 hover:bg-yellow-100"><i class="fas fa-book-open w-6 mr-2"></i>Cardápio</a>
                    <a href="./ofertas.html" class="block py-2 px-4 text-sm text-gray-700 hover:bg-yellow-100"><i class="fas fa-tags w-6 mr-2"></i>Ofertas</a>
                    <a href="./sobre.html" class="block py-2 px-4 text-sm text-gray-700 hover:bg-yellow-100"><i class="fas fa-users w-6 mr-2"></i>Sobre Nós</a>
                </div>
            </div>
            <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2">
                <a href="./index.html"><img src="./images/LANCHO_LOGO.png" alt="Logo Lanchô" class="h-16 w-auto"></a>
            </div>
            <div class="flex items-center space-x-4">
                <div id="user-menu-container" class="relative">
                     <!-- O menu do usuário será inserido aqui pelo JS -->
                </div>
            </div>
        </nav>
    </header>

    <main class="container mx-auto p-4 md:p-8 flex-grow">
        <div class="max-w-7xl mx-auto">
            <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                <div>
                    <h1 class="text-4xl font-black text-gray-800">Gerenciar Produtos</h1>
                    <p class="text-gray-500 mt-1">Edite, exclua e controle o estoque dos seus produtos.</p>
                </div>
                <a href="./admin.html" class="text-sm text-yellow-600 hover:underline">‹ Voltar ao Painel</a>
            </div>

            <!-- Barra de Ferramentas: Filtros e Busca -->
            <div class="mb-6 p-4 bg-white rounded-lg shadow-sm flex flex-col md:flex-row items-center gap-4">
                <div class="relative w-full md:w-1/3">
                    <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    <input type="text" id="search-input" placeholder="Buscar por nome..." class="w-full pl-10 pr-4 py-2 border rounded-full focus:ring-2 focus:ring-yellow-400 focus:outline-none">
                </div>
                <div id="category-filters" class="flex-grow flex flex-wrap justify-center md:justify-start gap-2">
                    <!-- Botões de categoria serão inseridos aqui -->
                </div>
            </div>

            <!-- Grid de Produtos -->
            <div id="product-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
                <!-- Cards de produto serão inseridos aqui -->
            </div>
            <div id="loading-indicator" class="text-center py-16">
                <i class="fas fa-spinner fa-spin fa-3x text-yellow-500"></i>
                <p class="mt-4 text-gray-600">Carregando produtos...</p>
            </div>
             <div id="no-results" class="hidden text-center py-16">
                <i class="fas fa-box-open fa-3x text-gray-400"></i>
                <p class="mt-4 text-gray-600">Nenhum produto encontrado.</p>
            </div>
        </div>
    </main>
    
    <!-- Modal de Edição -->
    <div id="edit-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4 modal opacity-0">
        <div id="edit-modal-content" class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col transform scale-95 modal-content">
            <!-- Conteúdo do modal é gerado dinamicamente -->
        </div>
    </div>

     <!-- Modal de Confirmação -->
    <div id="confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-[60] flex items-center justify-center p-4 modal opacity-0">
        <div class="bg-white p-8 rounded-lg shadow-2xl text-center max-w-sm mx-auto modal-content transform scale-95">
            <i class="fas fa-exclamation-triangle fa-3x text-yellow-500 mb-4"></i>
            <h2 class="text-2xl font-bold my-4">Tem Certeza?</h2>
            <p id="confirm-message" class="text-gray-600 mb-6"></p>
            <div class="flex justify-center gap-4">
                <button id="cancel-confirm-button" class="py-2 px-6 bg-gray-200 text-gray-700 rounded-full hover:bg-gray-300">Cancelar</button>
                <button id="confirm-action-button" class="py-2 px-6 bg-red-600 text-white rounded-full hover:bg-red-700">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="hidden fixed top-24 right-8 text-white py-3 px-6 rounded-lg shadow-lg z-[70] transform translate-x-full toast"></div>

    <footer class="bg-gray-800 text-white mt-auto">
        <div class="container mx-auto px-4 md:px-8 py-12">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8 text-center md:text-left">
                <div><h3 class="text-lg font-bold text-yellow-500 mb-4">Lanchô</h3><p class="text-gray-400">O melhor lanche da região, feito com carinho e os ingredientes mais frescos.</p></div>
                <div><h3 class="text-lg font-bold mb-4">Links Rápidos</h3><ul class="space-y-2"><li><a href="./index.html" class="text-gray-400 hover:text-white">Home</a></li><li><a href="./catalog.html" class="text-gray-400 hover:text-white">Cardápio</a></li></ul></div>
                <div><h3 class="text-lg font-bold mb-4">Contato</h3><ul class="space-y-2 text-gray-400"><li>Rua Mariz e Barros, 273, Rio de Janeiro</li><li>(21) 96810-5812</li><li>contato@lancho.com.br</li></ul></div>
                <div><h3 class="text-lg font-bold mb-4">Siga-nos</h3><div class="flex justify-center md:justify-start space-x-4"><a href="#" class="text-gray-400 hover:text-white"><i class="fab fa-instagram fa-lg"></i></a><a href="#" class="text-gray-400 hover:text-white"><i class="fab fa-twitter fa-lg"></i></a></div></div>
            </div>
            <div class="border-t border-gray-700 mt-8 pt-6 text-center text-gray-500"><p>&copy; 2025 Lanchô. Todos os direitos reservados.</p></div>
        </div>
    </footer>

    <script>
        // --- CONFIGURAÇÃO E VARIÁVEIS GLOBAIS ---
        const SUPABASE_URL = 'https://ygsziltorjcgpjbmlptr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlnc3ppbHRvcmpjZ3BqYm1scHRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgyOTUzNTQsImV4cCI6MjA2Mzg3MTM1NH0.3J19gnI_qwM3nWolVdvCcNNusC3YlOTvZEjOwM6z2PU';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        const productGrid = document.getElementById('product-grid');
        const loadingIndicator = document.getElementById('loading-indicator');
        const noResults = document.getElementById('no-results');
        const searchInput = document.getElementById('search-input');
        const categoryFilters = document.getElementById('category-filters');
        
        const editModal = document.getElementById('edit-modal');
        const editModalContent = document.getElementById('edit-modal-content');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmMessage = document.getElementById('confirm-message');
        const cancelConfirmButton = document.getElementById('cancel-confirm-button');
        const confirmActionButton = document.getElementById('confirm-action-button');
        const toast = document.getElementById('toast');

        let allProducts = [];
        let loggedUser = null;

        // --- FUNÇÕES DE RENDERIZAÇÃO E UI ---
        
        function renderProducts(productsToRender) {
            productGrid.innerHTML = '';
            if (productsToRender.length === 0) {
                noResults.style.display = 'block';
                return;
            }
            noResults.style.display = 'none';
            productsToRender.forEach(product => {
                const stock = product.Estoque || { quantidade: 0 };
                const stockColor = stock.quantidade <= 5 ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800';
                const stockText = stock.quantidade > 0 ? `${stock.quantidade} em estoque` : 'Sem estoque';

                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-md overflow-hidden flex flex-col product-card';
                card.innerHTML = `
                    <img src="${product.image_url}" alt="${product.nome}" class="w-full h-48 object-cover">
                    <div class="p-4 flex flex-col flex-grow">
                        <div class="flex justify-between items-start">
                            <h3 class="text-lg font-bold">${product.nome}</h3>
                            <span class="text-xs font-semibold px-2 py-1 rounded-full ${stockColor}">${stockText}</span>
                        </div>
                        <p class="text-sm text-gray-500">${product.categoria}</p>
                        <div class="flex-grow"></div>
                        <div class="flex justify-between items-center mt-4">
                            <span class="text-xl font-black text-red-600">R$ ${parseFloat(product.preco).toFixed(2).replace('.', ',')}</span>
                            <div class="flex gap-2">
                                <button class="edit-btn bg-yellow-400 text-yellow-900 w-10 h-10 rounded-full hover:bg-yellow-500 flex items-center justify-center" data-product='${JSON.stringify(product).replace(/'/g, "&apos;")}'><i class="fas fa-pencil-alt"></i></button>
                                <button class="delete-btn bg-red-500 text-white w-10 h-10 rounded-full hover:bg-red-600 flex items-center justify-center" data-product-id="${product.id}" data-stripe-id="${product.stripe_price_id}" data-product-name="${product.nome.replace(/"/g, '&quot;')}"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    </div>
                `;
                productGrid.appendChild(card);
            });
            
            addCardButtonListeners();
        }

        function addCardButtonListeners() {
            productGrid.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    event.stopPropagation();
                    const productData = JSON.parse(button.dataset.product);
                    openEditModal(productData);
                });
            });

            productGrid.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    event.stopPropagation();
                    const { productId, stripeId, productName } = button.dataset;
                    confirmDelete(productId, stripeId, productName);
                });
            });
        }
        
        function renderCategoryFilters(products) {
            const categories = ['Todos', ...new Set(products.map(p => p.categoria).filter(Boolean))];
            categoryFilters.innerHTML = categories.map(cat => `
                <button class="category-filter-btn px-4 py-1.5 text-sm font-semibold rounded-full bg-gray-200 text-gray-700 hover:bg-yellow-400 hover:text-yellow-900 transition-colors" data-category="${cat}">
                    ${cat}
                </button>
            `).join('');
            
            categoryFilters.querySelector('[data-category="Todos"]').classList.add('bg-yellow-500', 'text-white', 'hover:bg-yellow-500');
            
            categoryFilters.querySelectorAll('.category-filter-btn').forEach(button => {
                button.addEventListener('click', () => {
                    categoryFilters.querySelectorAll('.category-filter-btn').forEach(btn => {
                        btn.classList.remove('bg-yellow-500', 'text-white', 'hover:bg-yellow-500');
                        btn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-yellow-400', 'hover:text-yellow-900');
                    });
                    button.classList.add('bg-yellow-500', 'text-white', 'hover:bg-yellow-500');
                    filterProducts();
                });
            });
        }

        function filterProducts() {
            const searchTerm = searchInput.value.toLowerCase();
            const activeCategoryButton = categoryFilters.querySelector('.bg-yellow-500');
            if (!activeCategoryButton) return;
            const activeCategory = activeCategoryButton.dataset.category;
            
            const filtered = allProducts.filter(product => {
                const matchesSearch = product.nome.toLowerCase().includes(searchTerm);
                const matchesCategory = activeCategory === 'Todos' || product.categoria === activeCategory;
                return matchesSearch && matchesCategory;
            });
            
            renderProducts(filtered);
        }

        function showToast(message, isError = false) {
            toast.innerHTML = `<i class="fas ${isError ? 'fa-times-circle' : 'fa-check-circle'} mr-2"></i> ${message}`;
            toast.className = `fixed top-24 right-8 text-white py-3 px-6 rounded-lg shadow-lg z-[70] transform translate-x-full opacity-0 ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            toast.classList.remove('hidden');
            setTimeout(() => { toast.classList.remove('translate-x-full', 'opacity-0'); }, 10);
            setTimeout(() => {
                toast.classList.add('translate-x-full', 'opacity-0');
                setTimeout(() => toast.classList.add('hidden'), 300);
            }, 3000);
        }

        function openModal(modal) {
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.querySelector('.modal-content').classList.remove('scale-95');
            }, 10);
        }

        function closeModal(modal) {
            modal.classList.add('opacity-0');
            modal.querySelector('.modal-content').classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        // --- FUNÇÕES DE DADOS (FETCH, UPDATE, DELETE) ---
        
        async function loadProducts() {
            loadingIndicator.style.display = 'block';
            productGrid.innerHTML = '';
            noResults.style.display = 'none';
            try {
                const { data, error } = await supabaseClient.from('Produto').select('*, Estoque(*)').order('nome', { ascending: true });
                if (error) throw error;
                allProducts = data;
                renderProducts(allProducts);
                renderCategoryFilters(allProducts);
            } catch (error) {
                console.error("Erro ao carregar produtos:", error);
                productGrid.innerHTML = `<p class="text-red-500 col-span-full text-center">Erro ao carregar produtos: ${error.message}</p>`;
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }

        async function saveProductChanges(productId) {
            const form = document.getElementById('edit-product-form');
            const button = form.querySelector('button[type="submit"]');
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Salvando...';
            
            try {
                const updates = {
                    nome: form.nome.value,
                    descricao: form.descricao.value,
                    preco: parseFloat(form.preco.value),
                    categoria: form.categoria.value,
                };

                const imageFile = form.image.files[0];
                if (imageFile) {
                    const fileName = `${productId}-${Date.now()}-${imageFile.name}`;
                    const { data: uploadData, error: uploadError } = await supabaseClient.storage.from('produtos').upload(fileName, imageFile, { upsert: true });
                    if (uploadError) throw uploadError;
                    updates.image_url = supabaseClient.storage.from('produtos').getPublicUrl(fileName).data.publicUrl;
                }

                const { error: updateError } = await supabaseClient.from('Produto').update(updates).eq('id', productId);
                if (updateError) throw updateError;
                
                const stockInput = form.querySelector('.quantity-input');
                const stockQuantity = parseInt(stockInput.value);
                
                const { error: stockError } = await supabaseClient
                    .from('Estoque')
                    .upsert({ id_produto: productId, quantidade: stockQuantity }, { onConflict: 'id_produto' });
                if(stockError) throw stockError;
                
                showToast('Produto atualizado com sucesso!', false);
                closeModal(editModal);
                await loadProducts();
            } catch (error) {
                console.error("Erro ao salvar produto:", error);
                showToast(`Erro: ${error.message}`, true);
            } finally {
                button.disabled = false;
                button.innerHTML = 'Salvar Alterações';
            }
        }
        
        function confirmDelete(productId, stripePriceId, productName) {
            confirmMessage.textContent = `Você realmente quer excluir "${productName}"? Esta ação removerá o produto do site e do sistema de pagamentos.`;
            openModal(confirmModal);
            confirmActionButton.onclick = () => executeDelete(productId, stripePriceId, productName);
        }
        
        async function executeDelete(productId, stripePriceId, productName) {
            confirmActionButton.disabled = true;
            confirmActionButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Excluindo...';
            try {
                if (stripePriceId && stripePriceId !== 'null') {
                    await supabaseClient.functions.invoke('delete-stripe-product', { body: { priceId: stripePriceId } });
                }
                await supabaseClient.from('avaliacoes').delete().eq('produto_id', productId);
                await supabaseClient.from('Estoque').delete().eq('id_produto', productId);
                const { error: dbError } = await supabaseClient.from('Produto').delete().eq('id', productId);
                if (dbError) throw dbError;
                showToast(`"${productName}" foi excluído.`, false);
                await loadProducts();
            } catch (error) {
                console.error("Erro ao excluir produto:", error);
                showToast(`Erro ao excluir: ${error.message}`, true);
            } finally {
                confirmActionButton.disabled = false;
                confirmActionButton.textContent = 'Confirmar';
                closeModal(confirmModal);
            }
        }

        // --- FUNÇÕES DO MODAL DE EDIÇÃO ---

        function openEditModal(product) {
            openModal(editModal);
            const stock = product.Estoque || { quantidade: 0 };
            
            editModalContent.innerHTML = `
                <div class="flex justify-between items-center p-6 border-b">
                    <h3 class="text-2xl font-bold">Editar ${product.nome}</h3>
                    <button type="button" onclick="closeModal(editModal)" class="p-2 rounded-full text-gray-500 hover:bg-gray-200 text-2xl">&times;</button>
                </div>
                <form id="edit-product-form" class="flex flex-col flex-grow">
                    <div class="p-6 overflow-y-auto space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label for="nome" class="block text-sm font-medium">Nome</label><input type="text" name="nome" value="${product.nome}" required class="mt-1 w-full border-gray-300 rounded-md shadow-sm focus:ring-yellow-500 focus:border-yellow-500"></div>
                            <div><label for="preco" class="block text-sm font-medium">Preço</label><input type="number" step="0.01" name="preco" value="${product.preco}" required class="mt-1 w-full border-gray-300 rounded-md shadow-sm focus:ring-yellow-500 focus:border-yellow-500"></div>
                        </div>
                        <div><label for="descricao" class="block text-sm font-medium">Descrição</label><textarea name="descricao" rows="3" required class="mt-1 w-full border-gray-300 rounded-md shadow-sm focus:ring-yellow-500 focus:border-yellow-500">${product.descricao}</textarea></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                             <div>
                                <label for="categoria" class="block text-sm font-medium">Categoria</label>
                                <select name="categoria" class="mt-1 w-full border-gray-300 rounded-md shadow-sm focus:ring-yellow-500 focus:border-yellow-500">
                                    ${['Sanduíches', 'Combos', 'Acompanhamentos', 'Sobremesas', 'Bebidas', 'Mais Vendidos'].map(cat => `<option value="${cat}" ${product.categoria === cat ? 'selected' : ''}>${cat}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium">Estoque</label>
                                <div class="quantity-stepper mt-1">
                                    <button type="button" class="quantity-btn quantity-minus">-</button>
                                    <input type="number" value="${stock.quantidade}" min="0" class="quantity-input">
                                    <button type="button" class="quantity-btn quantity-plus">+</button>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium">Imagem</label>
                            <div class="mt-1 flex items-center space-x-4">
                                <img id="edit-image-preview" src="${product.image_url}" class="w-24 h-24 rounded-md object-cover">
                                <label class="cursor-pointer bg-yellow-500 text-white font-bold py-2 px-4 rounded-full hover:bg-yellow-600">
                                    <span>Alterar</span><input type="file" name="image" class="sr-only" accept="image/png, image/jpeg">
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="p-6 bg-gray-50 border-t flex justify-end gap-3 mt-auto">
                        <button type="button" onclick="closeModal(editModal)" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-full hover:bg-gray-300">Cancelar</button>
                        <button type="submit" class="bg-red-600 text-white font-bold py-2 px-4 rounded-full hover:bg-red-700">Salvar Alterações</button>
                    </div>
                </form>
            `;

            const form = document.getElementById('edit-product-form');
            form.addEventListener('submit', (e) => { e.preventDefault(); saveProductChanges(product.id); });
            
            form.querySelector('input[name="image"]').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) document.getElementById('edit-image-preview').src = URL.createObjectURL(file);
            });

            form.querySelectorAll('.quantity-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const input = button.parentElement.querySelector('.quantity-input');
                    let val = parseInt(input.value);
                    if (button.classList.contains('quantity-plus')) input.value = val + 1;
                    else if (val > 0) input.value = val - 1;
                });
            });
        }
        
        // --- FUNÇÕES DE AUTENTICAÇÃO E SETUP ---
        
        async function checkAdminAndSetup() {
            const userString = localStorage.getItem('currentAdmin');
            if (!userString || JSON.parse(userString).role !== 'admin') {
                document.body.innerHTML = `<div class="h-screen w-screen flex flex-col items-center justify-center bg-gray-100"><i class="fas fa-lock fa-3x text-red-500"></i><h1 class="text-2xl font-bold mt-4">Acesso Negado</h1><p class="text-gray-600">Você não tem permissão para ver esta página.</p><a href="./index.html" class="mt-6 text-blue-600 hover:underline">Voltar para a Home</a></div>`;
                return;
            }
            loggedUser = JSON.parse(userString);
            await updateNavUI(loggedUser);
            await loadProducts();
        }

        async function updateNavUI(user) {
            const userMenuContainer = document.getElementById('user-menu-container');
            const avatar = user.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.nome || user.email)}&background=fde68a&color=c2410c`;
            userMenuContainer.innerHTML = `
                <button id="user-menu-button" class="p-2 rounded-full"><img src="${avatar}" alt="Avatar" class="w-8 h-8 rounded-full object-cover"></button>
                <div id="user-menu-dropdown" class="hidden absolute right-0 mt-2 w-72 bg-white rounded-lg shadow-xl z-30">
                     <div class="p-4 border-b"><div class="flex items-center"><img src="${avatar}" alt="Avatar" class="w-16 h-16 rounded-full object-cover"><div class="ml-4"><p class="font-semibold">${user.nome}</p><p class="text-xs text-gray-500">${user.email}</p></div></div></div>
                     <div class="p-2">
                        <a href="./profile.html" class="w-full text-left flex items-center text-sm text-gray-700 hover:bg-gray-100 p-2 rounded"><i class="fas fa-user-edit w-6 mr-2"></i>Editar Perfil</a>
                        <a href="./admin.html" class="w-full text-left flex items-center text-sm text-blue-600 hover:bg-gray-100 p-2 rounded"><i class="fas fa-user-shield w-6 mr-2"></i>Painel Admin</a>
                     </div>
                     <div class="p-2 border-t"><button id="logout-button" class="w-full text-left flex items-center text-sm text-red-600 hover:bg-red-50 p-2 rounded"><i class="fas fa-sign-out-alt w-6 mr-2"></i>Sair</button></div>
                </div>`;
            
            userMenuContainer.querySelector('#user-menu-button').addEventListener('click', (e) => { 
                e.stopPropagation();
                userMenuContainer.querySelector('#user-menu-dropdown').classList.toggle('hidden');
            });
            userMenuContainer.querySelector('#logout-button').onclick = () => { 
                localStorage.removeItem('currentAdmin');
                window.location.href = './index.html'; 
            };
        }

        // --- INICIALIZAÇÃO E LISTENERS GLOBAIS ---
        
        document.addEventListener('DOMContentLoaded', () => {
            checkAdminAndSetup();
            searchInput.addEventListener('input', filterProducts);
            
            cancelConfirmButton.addEventListener('click', () => closeModal(confirmModal));
            
            const mainMenuButton = document.getElementById('main-menu-button');
            const mainMenuDropdown = document.getElementById('main-menu-dropdown');
            mainMenuButton.addEventListener('click', (e) => { e.stopPropagation(); mainMenuDropdown.classList.toggle('hidden'); });
            
            window.addEventListener('click', (e) => {
                if (!mainMenuDropdown.classList.contains('hidden') && !mainMenuButton.contains(e.target)) {
                    mainMenuDropdown.classList.add('hidden');
                }
                const userMenuDropdown = document.getElementById('user-menu-dropdown');
                if (userMenuDropdown && !userMenuDropdown.classList.contains('hidden') && !userMenuDropdown.parentElement.contains(e.target)) {
                    userMenuDropdown.classList.add('hidden');
                }
                if (e.target === editModal) {
                    closeModal(editModal);
                }
            });
        });
    </script>
</body>
</html>

