<!DOCTYPE html>
<html lang="pt-BR" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cardápio - Lanchô</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .product-card { display: flex; flex-direction: column; }
        .product-card-content { flex-grow: 1; display: flex; flex-direction: column; }
        .product-card-description { flex-grow: 1; }
        .star-rating-display { color: #f59e0b; }
        .star-rating { border: none; }
        .star-rating input { display: none; }
        .star-rating label { font-size: 2.5rem; color: #d1d5db; cursor: pointer; float: right; transition: color 0.2s; }
        .star-rating input:checked ~ label, .star-rating label:hover, .star-rating label:hover ~ label { color: #f59e0b; }
        .modal { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex flex-col min-h-screen">

    <header class="bg-white shadow-md sticky top-0 z-30">
        <nav class="container mx-auto px-4 md:px-8 py-3 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-yellow-600"><a href="./index.html">Lanchô</a></h1>
            <div class="flex items-center space-x-2 md:space-x-4">
                <div class="relative">
                    <button id="menu-toggle-button" class="p-2 rounded-full text-gray-600 hover:bg-gray-200 focus:outline-none">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" /></svg>
                    </button>
                    <div id="dropdown-menu" class="hidden absolute right-0 mt-2 w-64 bg-white rounded-lg shadow-xl overflow-hidden z-40">
                        <div id="user-section" class="hidden p-4 border-b border-gray-200"></div>
                        <div id="login-section" class="p-4 border-b border-gray-200"><a href="./login.html" class="block w-full text-center bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full transition-colors">Fazer Login</a></div>
                        <a id="my-orders-link" href="./orders.html" class="hidden block py-2 px-4 text-sm text-gray-700 hover:bg-yellow-100">Meus Pedidos</a>
                        <a id="admin-panel-link" href="./admin.html" class="hidden block py-2 px-4 text-sm text-blue-600 hover:bg-gray-100">Painel Admin</a>
                        <div id="logout-section" class="hidden p-2 border-t border-gray-200"><button id="logout-button" class="w-full text-left text-sm text-red-600 hover:bg-red-50 p-2 rounded">Sair</button></div>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <main class="container mx-auto p-4 md:p-8 flex-grow">
        <h2 class="text-4xl font-bold text-center mb-10 text-yellow-600">Nosso Cardápio</h2>
        <div id="product-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <p id="loading-message" class="col-span-full text-center text-gray-500 text-lg"><svg class="animate-spin h-8 w-8 text-yellow-600 mx-auto mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Carregando cardápio...</p>
        </div>
    </main>

    <footer class="bg-yellow-800 text-yellow-50 mt-12"><div class="container mx-auto px-4 md:px-8 py-8 text-center"><p>&copy; 2025 Lanchô. Todos os direitos reservados.</p></div></footer>

    <div id="product-modal" class="fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4 hidden opacity-0 modal">
        <div id="modal-content" class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col transform scale-95 modal-content"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://ygsziltorjcgpjbmlptr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlnc3ppbHRvcmpjZ3BqYm1scHRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgyOTUzNTQsImV4cCI6MjA2Mzg3MTM1NH0.3J19gnI_qwM3nWolVdvCcNNusC3YlOTvZEjOwM6z2PU';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const productListContainer = document.getElementById('product-list');
        const loadingMessage = document.getElementById('loading-message');
        const modal = document.getElementById('product-modal');
        const modalContent = document.getElementById('modal-content');
        let currentUser = null;

        function setupMenu() {
            const btn = document.getElementById('menu-toggle-button');
            const menu = document.getElementById('dropdown-menu');
            btn.addEventListener('click', e => { e.stopPropagation(); menu.classList.toggle('hidden'); });
            window.addEventListener('click', e => { if (!menu.classList.contains('hidden') && !menu.contains(e.target) && !btn.contains(e.target)) menu.classList.add('hidden'); });
        }

        function updateNavUI(user) {
            const userSection = document.getElementById('user-section');
            const loginSection = document.getElementById('login-section');
            const logoutSection = document.getElementById('logout-section');
            const adminPanelLink = document.getElementById('admin-panel-link');
            const myOrdersLink = document.getElementById('my-orders-link');
            const logoutButton = document.getElementById('logout-button');

            if (user) {
                const avatar = user.avatar_url || `https://ui-avatars.com/api/?name=${user.nome || user.email}&background=fde68a&color=c2410c`;
                userSection.innerHTML = `<div class="flex items-center"><a href="./profile.html" class="w-10 h-10 rounded-full flex-shrink-0"><img src="${avatar}" alt="Avatar" class="w-full h-full rounded-full object-cover"></a><div class="ml-3"><a href="./profile.html" class="text-sm font-semibold text-gray-800 hover:text-yellow-600">Olá, ${user.nome || 'Cliente'}!</a></div></div>`;
                userSection.classList.remove('hidden');
                logoutSection.classList.remove('hidden');
                myOrdersLink.classList.remove('hidden');
                loginSection.classList.add('hidden');
                if (user.email === 'admin@lancho.com') adminPanelLink.classList.remove('hidden');
                logoutButton.onclick = () => { localStorage.removeItem('currentUser'); window.location.reload(); };
            } else {
                userSection.classList.add('hidden');
                logoutSection.classList.add('hidden');
                myOrdersLink.classList.add('hidden');
                adminPanelLink.classList.add('hidden');
                loginSection.classList.remove('hidden');
            }
        }

        function getStarRatingDisplay(rating) {
            let html = '<div class="star-rating-display flex items-center space-x-1">';
            const full = Math.floor(rating), half = rating % 1 >= 0.4, empty = 5 - full - (half ? 1 : 0);
            for (let i = 0; i < full; i++) html += '<i class="bi bi-star-fill"></i>';
            if (half) html += '<i class="bi bi-star-half"></i>';
            for (let i = 0; i < empty; i++) html += '<i class="bi bi-star"></i>';
            return html + '</div>';
        }

        async function loadProducts() {
            try {
                const { data, error } = await supabaseClient.from('Produto').select('*').order('nome', { ascending: true });
                if (error) throw error;
                loadingMessage.style.display = 'none';
                productListContainer.innerHTML = '';
                if (!data || data.length === 0) {
                    productListContainer.innerHTML = '<p class="col-span-full text-center text-gray-500">Nenhum produto disponível.</p>';
                    return;
                }
                data.forEach(p => {
                    const card = document.createElement('div');
                    card.className = 'bg-white rounded-lg shadow-lg overflow-hidden product-card hover:shadow-xl transition-shadow duration-300';
                    card.innerHTML = `<img src="${p.image_url || './images/lanchoxburger.jpg'}" alt="Foto de ${p.nome}" class="w-full h-56 object-cover cursor-pointer"><div class="p-6 product-card-content"><div class="product-card-description"><div class="flex justify-between items-baseline mb-2"><h3 class="text-2xl font-semibold cursor-pointer hover:text-yellow-600">${p.nome}</h3><p class="text-xl font-bold text-green-600">R$${parseFloat(p.preco).toFixed(2).replace('.', ',')}</p></div><div class="flex items-center mb-3">${getStarRatingDisplay(p.media_avaliacoes)}<span class="text-xs text-gray-500 ml-2">(${p.total_avaliacoes} ${p.total_avaliacoes === 1 ? 'avaliação' : 'avaliações'})</span></div><p class="text-gray-600 mb-4">${p.descricao}</p></div><button class="mt-auto block w-full text-center bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-full transition-colors buy-button" data-price-id="${p.stripe_price_id}">Comprar</button></div>`;
                    productListContainer.appendChild(card);
                    card.querySelector('img').onclick = () => openProductModal(p);
                    card.querySelector('h3').onclick = () => openProductModal(p);
                    card.querySelector('.buy-button').onclick = e => { e.stopPropagation(); buyProduct(e.target.dataset.priceId, e.target); };
                });
            } catch (error) {
                console.error('Erro ao carregar produtos:', error);
                loadingMessage.textContent = 'Falha ao carregar o cardápio. Tente recarregar a página.';
            }
        }

        async function fetchReviews(productId) {
            const { data, error } = await supabaseClient.from('avaliacoes').select('*, Cliente!inner(id, nome, avatar_url)').eq('produto_id', productId).order('created_at', { ascending: false });
            if (error) { console.error('Erro ao buscar avaliações:', error); return []; }
            return data;
        }

        async function openProductModal(product) {
            modal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
            setTimeout(() => { modal.classList.remove('opacity-0'); modalContent.classList.remove('scale-95'); }, 10);
            modalContent.innerHTML = `<div class="p-8 text-center"><svg class="animate-spin h-8 w-8 text-yellow-600 mx-auto" ...></svg></div>`;
            const reviews = await fetchReviews(product.id);
            modalContent.innerHTML = `<div class="flex justify-between items-center p-4 border-b"><h3 class="text-2xl font-bold">${product.nome}</h3><button id="close-modal" class="p-2 rounded-full text-gray-500 hover:bg-gray-200">&times;</button></div><div class="p-6 overflow-y-auto"><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><img src="${product.image_url || './images/lanchoxburger.jpg'}" class="w-full h-auto rounded-lg shadow-md"><div><p class="text-gray-600 mb-4">${product.descricao || 'Sem descrição.'}</p><p class="text-3xl font-bold text-green-600 mb-4">R$${parseFloat(product.preco).toFixed(2).replace('.', ',')}</p><div class="flex items-center mb-6">${getStarRatingDisplay(product.media_avaliacoes)}<span class="ml-3 text-gray-600">${Number(product.media_avaliacoes).toFixed(1)} de 5</span></div></div></div><hr class="my-6"><h4 class="text-xl font-bold mb-4">Avaliações</h4><div class="bg-gray-50 rounded-lg p-4 mb-6"><h5 class="font-semibold mb-2">Deixe sua avaliação</h5><fieldset class="star-rating mb-2 flex flex-row-reverse justify-end"><input type="radio" id="star5" name="rating" value="5" /><label for="star5">&#9733;</label><input type="radio" id="star4" name="rating" value="4" /><label for="star4">&#9733;</label><input type="radio" id="star3" name="rating" value="3" /><label for="star3">&#9733;</label><input type="radio" id="star2" name="rating" value="2" /><label for="star2">&#9733;</label><input type="radio" id="star1" name="rating" value="1" /><label for="star1">&#9733;</label></fieldset><textarea id="review-comment" class="w-full mt-2 p-2 border rounded-md" rows="3" placeholder="Escreva seu comentário..."></textarea><button id="submit-review" class="mt-3 w-full bg-yellow-600 text-white py-2 px-4 rounded-lg hover:bg-yellow-700">Enviar</button><p id="review-message" class="text-sm text-center mt-2"></p></div><div id="reviews-list" class="space-y-6">${reviews.length > 0 ? reviews.map(r => `<div class="flex"><img src="${r.Cliente.avatar_url || `https://ui-avatars.com/api/?name=${r.Cliente.nome}`}" class="w-12 h-12 rounded-full mr-4"><div class="w-full"><div class="flex items-center justify-between"><p class="font-semibold">${r.Cliente.nome}</p>${getStarRatingDisplay(r.nota)}</div><p class="text-xs text-gray-500 mb-1">${new Date(r.created_at).toLocaleDateString('pt-BR')}</p><p class="text-gray-700">${r.comentario || ''}</p></div></div>`).join('<hr>') : '<p class="text-gray-500 text-center">Seja o primeiro a avaliar!</p>'}</div></div>`;
            document.getElementById('close-modal').onclick = closeProductModal;
            document.getElementById('submit-review').onclick = () => submitReview(product.id);
        }

        function closeProductModal() {
            modal.classList.add('opacity-0');
            modalContent.classList.add('scale-95');
            setTimeout(() => { modal.classList.add('hidden'); document.body.classList.remove('overflow-hidden'); }, 300);
        }

        modal.addEventListener('click', e => { if (e.target === modal) closeProductModal(); });

        async function buyProduct(priceId, buttonElement) {
            if (!currentUser) {
                alert('Você precisa fazer login para comprar!');
                window.location.href = './login.html';
                return;
            }
            buttonElement.disabled = true;
            buttonElement.innerHTML = `<svg class="animate-spin h-5 w-5 mx-auto" ...></svg>`;
            try {
                const { data, error } = await supabaseClient.functions.invoke('create-checkout-session', {
                    body: { priceId: priceId, clienteId: currentUser.id, customerEmail: currentUser.email },
                });
                if (error) {
                    const errorBody = await error.context.json();
                    throw new Error(errorBody.error || `A função retornou um erro ${error.context.status}.`);
                }
                window.location.href = data.checkoutUrl;
            } catch (e) {
                console.error('Erro detalhado ao criar checkout:', e);
                alert(`Ocorreu um erro ao iniciar o pagamento:\n\n${e.message}`);
                buttonElement.disabled = false;
                buttonElement.textContent = 'Comprar';
            }
        }

        async function submitReview(productId) {
            console.log("A função submitReview foi chamada para o produto ID:", productId);
            const ratingInput = document.querySelector('#product-modal input[name="rating"]:checked');
            const commentInput = document.getElementById('review-comment');
            const messageP = document.getElementById('review-message');
            const submitButton = document.getElementById('submit-review');

            if (!currentUser) {
                messageP.textContent = 'Você precisa estar logado para avaliar.';
                messageP.className = 'text-sm text-center mt-2 text-red-600';
                return;
            }
            if (!ratingInput) {
                messageP.textContent = 'Por favor, selecione uma nota de 1 a 5 estrelas.';
                messageP.className = 'text-sm text-center mt-2 text-red-600';
                return;
            }
            
            submitButton.disabled = true;
            submitButton.innerHTML = `<svg class="animate-spin h-5 w-5 mx-auto" ...></svg> Enviando...`;
            
            const { error } = await supabaseClient.from('avaliacoes').insert({ 
                produto_id: productId, 
                cliente_id: currentUser.id, 
                nota: parseInt(ratingInput.value), 
                comentario: commentInput.value.trim() 
            });
            
            submitButton.disabled = false;
            submitButton.textContent = 'Enviar Avaliação';

            if (error) {
                console.error('Erro ao enviar avaliação:', error);
                messageP.textContent = `Erro: ${error.message.includes('duplicate key') ? 'Você já avaliou este produto.' : error.message}`;
                messageP.className = 'text-sm text-center mt-2 text-red-600';
            } else {
                messageP.textContent = 'Avaliação enviada com sucesso!';
                messageP.className = 'text-sm text-center mt-2 text-green-600';
                setTimeout(async () => {
                    loadProducts();
                    const { data: p } = await supabaseClient.from('Produto').select('*').eq('id', productId).single();
                    if(p) await openProductModal(p);
                }, 1500);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            setupMenu();
            const userString = localStorage.getItem('currentUser');
            currentUser = userString ? JSON.parse(userString) : null;
            updateNavUI(currentUser);
            loadProducts();
        });
    </script>
</body>
</html>
